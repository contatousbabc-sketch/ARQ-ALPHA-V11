<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARQV30 Enhanced v3.0 - Interface Aprimorada</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/magnetic-ui.css') }}">

    <style>
        /* Aplicar classes do Magnetic UI */
        .header {
            @extend .glass;
        }
        
        .config-section {
            @extend .glass;
        }
        
        .step-card {
            @extend .glass;
        }
        
        .progress-section {
            @extend .glass;
        }
        
        .sessions-container {
            @extend .glass;
        }
        
        /* Corre√ß√£o espec√≠fica para precis√£o da barra de progresso */
        .progress-bar {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .progress-percentage {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header glass">
            <img src="{{ logo_data_url }}" alt="USB MKT AM - Pro An√°lise de Mercado" class="header-logo">
            <div class="header-title">
                <h1><i class="fas fa-rocket"></i> ARQV30 Enhanced v3.0</h1>
            </div>
            <p>Sistema de An√°lise Ultra-Detalhada com Busca Massiva Real, Captura de Screenshots e IA com Ferramentas</p>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">3</div>
                    <div class="stat-label">Etapas de Workflow</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">16</div>
                    <div class="stat-label">M√≥dulos de An√°lise</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">100%</div>
                    <div class="stat-label">Dados Reais</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">0%</div>
                    <div class="stat-label">Simula√ß√£o</div>
                </div>
            </div>
        </div>

        <!-- Configura√ß√£o -->
        <div class="config-section glass">
            <h3><i class="fas fa-cog"></i> Configura√ß√£o da An√°lise</h3>
            <form id="analysisForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="segmento">
                                <i class="fas fa-bullseye"></i> Segmento de Mercado *
                            </label>
                            <input type="text" id="segmento" name="segmento" class="form-control" 
                                   placeholder="Ex: Tecnologia, Sa√∫de, E-commerce..." required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="produto">
                                <i class="fas fa-box"></i> Produto/Servi√ßo
                            </label>
                            <input type="text" id="produto" name="produto" class="form-control"
                                   placeholder="Nome do seu produto ou servi√ßo">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="preco">
                                <i class="fas fa-dollar-sign"></i> Pre√ßo (R$)
                            </label>
                            <input type="number" id="preco" name="preco" class="form-control" 
                                   step="0.01" placeholder="997.00">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="objetivo_receita">
                                <i class="fas fa-chart-line"></i> Objetivo de Receita (R$)
                            </label>
                            <input type="number" id="objetivo_receita" name="objetivo_receita" 
                                   class="form-control" step="0.01" placeholder="100000.00">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="publico">
                        <i class="fas fa-users"></i> P√∫blico-Alvo Detalhado
                    </label>
                    <textarea id="publico" name="publico" class="form-control" rows="4"
                              placeholder="Descreva detalhadamente seu p√∫blico-alvo: dores, desejos, caracter√≠sticas demogr√°ficas..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="contexto_adicional">
                        <i class="fas fa-plus-circle"></i> Contexto Adicional
                    </label>
                    <textarea id="contexto_adicional" name="contexto_adicional" class="form-control" rows="3"
                              placeholder="Informa√ß√µes adicionais relevantes para a an√°lise..."></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="openrouter_model">
                                <i class="fas fa-robot"></i> Modelo OpenRouter
                            </label>
                            <input type="text" id="openrouter_model" name="openrouter_model" class="form-control"
                                   placeholder="Digite o modelo desejado (ex: anthropic/claude-3-haiku:beta)">
                            <small class="text-muted">Modelo IA que processar√° a an√°lise</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="session_name">
                                <i class="fas fa-save"></i> Nome da Sess√£o
                            </label>
                            <input type="text" id="session_name" name="session_name" class="form-control"
                                   placeholder="Nome para salvar esta an√°lise">
                            <small class="text-muted">Deixe em branco para gerar automaticamente</small>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Gerenciamento de Sess√µes -->
        <div class="config-section">
            <h3><i class="fas fa-history"></i> Gerenciar Sess√µes</h3>
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-success btn-block" onclick="saveSession()">
                        <i class="fas fa-save"></i> Salvar Sess√£o
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning btn-block" onclick="pauseCurrentSession()" id="pauseBtn" disabled>
                        <i class="fas fa-pause"></i> Pausar An√°lise
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-info btn-block" onclick="showSavedSessions()">
                        <i class="fas fa-list"></i> Sess√µes Salvas
                    </button>
                </div>
            </div>

            <!-- Lista de Sess√µes Salvas -->
            <div id="savedSessions" class="sessions-container glass" style="margin-top: 20px;">
                <!-- Sess√µes ser√£o carregadas dinamicamente -->
            </div>
        </div>

        <!-- Workflow Steps -->
        <div class="workflow-container">
            <!-- Etapa 1 -->
            <div class="step-card glass" id="step1Card">
                <div class="step-number">1</div>
                <h3 class="step-title">Coleta Massiva Real</h3>
                <p class="step-description">
                    Busca massiva com rota√ß√£o de APIs, extra√ß√£o de conte√∫do viral e captura autom√°tica de screenshots
                </p>
                <div class="step-features">
                    <span class="feature-tag">üîÑ Rota√ß√£o de APIs</span>
                    <span class="feature-tag">üì∏ Screenshots Autom√°ticos</span>
                    <span class="feature-tag">üî• Conte√∫do Viral</span>
                    <span class="feature-tag">üåê M√∫ltiplos Provedores</span>
                </div>
                <button class="step-btn" id="step1Btn" onclick="startStep1()">
                    <i class="fas fa-database"></i>
                    <span>Iniciar Coleta Massiva</span>
                </button>
            </div>

            <!-- Etapa 2 -->
            <div class="step-card glass" id="step2Card">
                <div class="step-number">2</div>
                <h3 class="step-title">S√≠ntese com IA Ativa</h3>
                <p class="step-description">
                    IA analisa dados coletados e realiza buscas online ativas para validar e enriquecer informa√ß√µes
                </p>
                <div class="step-features">
                    <span class="feature-tag">ü§ñ IA com Ferramentas</span>
                    <span class="feature-tag">üîç Busca Ativa</span>
                    <span class="feature-tag">‚úÖ Valida√ß√£o Online</span>
                    <span class="feature-tag">üìä S√≠ntese JSON</span>
                </div>
                <button class="step-btn" id="step2Btn" onclick="startStep2()">
                    <i class="fas fa-brain"></i>
                    <span>Iniciar S√≠ntese IA</span>
                </button>
            </div>

            <!-- Verifica√ß√£o AI -->
            <div class="step-card glass" id="aiVerificationCard">
                <div class="step-number">ü§ñ</div>
                <h3 class="step-title">Verifica√ß√£o AI</h3>
                <p class="step-description">
                    Verifica√ß√£o inteligente dos dados coletados usando m√∫ltiplas camadas de IA antes da gera√ß√£o final
                </p>
                <div class="step-features">
                    <span class="feature-tag">üß† An√°lise de Sentimento</span>
                    <span class="feature-tag">üîç Detec√ß√£o de Vi√©s</span>
                    <span class="feature-tag">‚úÖ Valida√ß√£o LLM</span>
                    <span class="feature-tag">üìä Filtros Avan√ßados</span>
                </div>
                <button class="step-btn" id="aiVerificationBtn" onclick="startAIVerification()">
                    <i class="fas fa-robot"></i>
                    <span>Verificar com IA</span>
                </button>
            </div>

            <!-- Etapa 3 -->
            <div class="step-card glass" id="step3Card">
                <div class="step-number">3</div>
                <h3 class="step-title">Gera√ß√£o de 16 M√≥dulos</h3>
                <p class="step-description">
                    Gera√ß√£o autom√°tica de 16 m√≥dulos especializados e compila√ß√£o do relat√≥rio final completo
                </p>
                <div class="step-features">
                    <span class="feature-tag">üìù 16 M√≥dulos</span>
                    <span class="feature-tag">üîó Compila√ß√£o</span>
                    <span class="feature-tag">üìã Relat√≥rio Final</span>
                    <span class="feature-tag">üìÑ 25+ P√°ginas</span>
                </div>
                <button class="step-btn" id="step3Btn" onclick="startStep3()">
                    <i class="fas fa-cogs"></i>
                    <span>Gerar M√≥dulos</span>
                </button>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section glass" id="progressSection">
            <div class="progress-header">
                <div class="progress-title">
                    <i class="fas fa-cogs fa-spin"></i>
                    <span id="progressTitle">Workflow em Execu√ß√£o</span>
                </div>
                <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div class="progress-status" id="progressStatus">
                Iniciando workflow...
            </div>

            <div class="step-indicators">
                <div class="step-indicator" id="indicator1">1</div>
                <div class="step-line"></div>
                <div class="step-indicator" id="indicator2">2</div>
                <div class="step-line"></div>
                <div class="step-indicator" id="indicatorAI">ü§ñ</div>
                <div class="step-line"></div>
                <div class="step-indicator" id="indicator3">3</div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <h3><i class="fas fa-chart-bar"></i> Resultados da An√°lise</h3>

            <div class="results-tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">Vis√£o Geral</button>
                <button class="tab-btn" onclick="switchTab('modules')">16 M√≥dulos</button>
                <button class="tab-btn" onclick="switchTab('screenshots')">Screenshots</button>
                <button class="tab-btn" onclick="switchTab('data')">Dados Coletados</button>
            </div>

            <div class="tab-content active" id="overviewTab">
                <div id="overviewContent">
                    <!-- Conte√∫do da vis√£o geral -->
                </div>
            </div>

            <div class="tab-content" id="modulesTab">
                <div id="modulesContent">
                    <!-- Lista dos 16 m√≥dulos -->
                </div>
            </div>

            <div class="tab-content" id="screenshotsTab">
                <div id="screenshotsContent">
                    <!-- Screenshots capturados -->
                </div>
            </div>

            <div class="tab-content" id="dataTab">
                <div id="dataContent">
                    <!-- Dados brutos coletados -->
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="btn-group">

            <button class="btn btn-secondary" onclick="resetWorkflow()">
                <i class="fas fa-refresh"></i>
                <span>Resetar</span>
            </button>

            <button class="btn btn-secondary" onclick="downloadResults()" id="downloadBtn" style="display: none;">
                <i class="fas fa-download"></i>
                <span>Download Relat√≥rio</span>
            </button>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Modal for Session Management -->
    <div id="sessionModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" class="modal-title">Modal</h3>
            </div>
            <div id="modalBody" class="modal-body">
                <!-- Conte√∫do din√¢mico -->
            </div>
            <div id="modalFooter" class="modal-footer">
                <!-- Bot√µes din√¢micos -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Estados globais
        let currentSessionId = null;
        let workflowRunning = false;
        let progressInterval = null;

        // ===== GERENCIAMENTO DE SESS√ïES =====
        async function saveSession() {
            const sessionName = document.getElementById('session_name').value || 
                `An√°lise ${new Date().toLocaleString('pt-BR')}`;

            const segmento = document.getElementById('segmento').value;

            if (!segmento.trim()) {
                showNotification('Por favor, preencha o segmento de mercado', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/sessions/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId, // Envia o ID da sess√£o atual se existir
                        name: sessionName,
                        segmento: segmento,
                        produto: document.getElementById('produto').value,
                        preco: document.getElementById('preco').value,
                        objetivo_receita: document.getElementById('objetivo_receita').value,
                        publico: document.getElementById('publico').value,
                        contexto_adicional: document.getElementById('contexto_adicional').value,
                        openrouter_model: document.getElementById('openrouter_model').value
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentSessionId = result.session_id;
                    showNotification('Sess√£o "' + sessionName + '" salva com sucesso!', 'success');
                    loadSavedSessions();
                } else {
                    showNotification('Erro ao salvar sess√£o: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar sess√£o:', error);
                showNotification('Erro ao salvar sess√£o. Verifique sua conex√£o.', 'error');
            }
        }

        async function loadSavedSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Resposta n√£o √© JSON v√°lido');
                }
                
                const result = await response.json();
                const sessions = result.sessions || result;

                const container = document.getElementById('savedSessions');

                if (!Array.isArray(sessions) || sessions.length === 0) {
                    container.innerHTML = '<div class="empty-sessions"><i class="fas fa-inbox"></i><p>Nenhuma sess√£o salva ainda</p></div>';
                    return;
                }

                container.innerHTML = sessions.map(session => 
                    '<div class="session-item" data-session-id="' + session.id + '">' +
                        '<div class="session-header">' +
                            '<span class="session-name">' + session.name + '</span>' +
                            '<span class="session-status ' + session.status + '">' + getStatusText(session.status) + '</span>' +
                        '</div>' +
                        '<div class="session-details">' +
                            '<div><strong>Segmento:</strong> ' + (session.segmento || 'N/A') + '</div>' +
                            '<div><strong>Query:</strong> ' + (session.query || 'N/A') + '</div>' +
                            '<div><strong>Modelo:</strong> ' + (session.openrouter_model || 'N/A') + '</div>' +
                            '<div><strong>Criado:</strong> ' + new Date(session.created_at).toLocaleString('pt-BR') + '</div>' +
                        '</div>' +
                        '<div class="session-progress">' +
                            '<div class="session-progress-bar" style="width: ' + (session.progress_percentage || 0) + '%"></div>' +
                        '</div>' +
                        '<div class="session-actions">' +
                            (session.status === 'paused' ? 
                                '<button class="session-btn continue" onclick="continueSession(\'' + session.id + '\')">' +
                                    '<i class="fas fa-play"></i> Continuar' +
                                '</button>' : '') +
                            (session.status === 'active' ? 
                                '<button class="session-btn pause" onclick="pauseSession(\'' + session.id + '\')">' +
                                    '<i class="fas fa-pause"></i> Pausar' +
                                '</button>' : '') +
                            '<button class="session-btn rename" onclick="showRenameModal(\'' + session.id + '\', \'' + escapeHtml(session.name) + '\')">' +
                                '<i class="fas fa-edit"></i> Renomear' +
                            '</button>' +
                            '<button class="session-btn model" onclick="showModelModal(\'' + session.id + '\', \'' + escapeHtml(session.openrouter_model) + '\')">' +
                                '<i class="fas fa-robot"></i> Modelo' +
                            '</button>' +
                            '<button class="session-btn delete" onclick="deleteSession(\'' + session.id + '\')">' +
                                '<i class="fas fa-trash"></i> Excluir' +
                            '</button>' +
                        '</div>' +
                    '</div>'
                ).join('');
            } catch (error) {
                console.error('Erro ao carregar sess√µes:', error);
                document.getElementById('savedSessions').innerHTML = 
                    '<div class="alert alert-error">' +
                        '<i class="fas fa-exclamation-circle"></i>' +
                        'Erro ao carregar sess√µes: ' + error.message +
                    '</div>';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'active': return 'Ativa';
                case 'paused': return 'Pausada';
                case 'completed': return 'Conclu√≠da';
                default: return status;
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // Fun√ß√£o para mostrar sess√µes salvas
        function showSavedSessions() {
            const container = document.getElementById('savedSessions');
            if (container.style.display === 'none' || !container.style.display) {
                container.style.display = 'block';
                loadSavedSessions();
            } else {
                container.style.display = 'none';
            }
        }

        // Continua sess√£o pausada
        async function continueSession(sessionId) {
            try {
                const response = await fetch('/api/sessions/' + sessionId + '/continue', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Sess√£o continuada com sucesso!', 'success');
                    currentSessionId = sessionId;
                    
                    // Preenche formul√°rio com dados da sess√£o
                    const sessionData = result.session_data;
                    document.getElementById('segmento').value = sessionData.segmento || '';
                    document.getElementById('produto').value = sessionData.produto || '';
                    document.getElementById('preco').value = sessionData.preco || '';
                    document.getElementById('objetivo_receita').value = sessionData.objetivo_receita || '';
                    document.getElementById('publico').value = sessionData.publico || '';
                    document.getElementById('contexto_adicional').value = sessionData.contexto_adicional || '';
                    document.getElementById('openrouter_model').value = sessionData.openrouter_model || '';
                    document.getElementById('session_name').value = sessionData.name || '';

                    // Atualiza lista de sess√µes
                    loadSavedSessions();
                    
                    // Garante que os bot√µes estejam habilitados
                    ensureButtonsEnabled();
                } else {
                    showNotification('Erro ao continuar sess√£o: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro ao continuar sess√£o:', error);
                showNotification('Erro ao continuar sess√£o', 'error');
            }
        }

        // Pausa sess√£o espec√≠fica
        async function pauseSession(sessionId) {
            try {
                const response = await fetch('/api/sessions/' + sessionId + '/pause', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Sess√£o pausada com sucesso!', 'success');
                    loadSavedSessions(); // Atualiza a lista
                } else {
                    showNotification('Erro ao pausar sess√£o: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro ao pausar sess√£o:', error);
                showNotification('Erro ao pausar sess√£o', 'error');
            }
        }

        // Mostra modal para renomear
        function showRenameModal(sessionId, currentName) {
            const modal = document.getElementById('sessionModal');
            document.getElementById('modalTitle').textContent = 'Renomear Sess√£o';
            document.getElementById('modalBody').innerHTML = 
                '<div class="form-group">' +
                    '<label for="newSessionName">Novo nome:</label>' +
                    '<input type="text" id="newSessionName" class="form-control" value="' + currentName + '">' +
                '</div>';
            document.getElementById('modalFooter').innerHTML = 
                '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>' +
                '<button class="btn btn-primary" onclick="renameSession(\'' + sessionId + '\')">Renomear</button>';
            
            modal.style.display = 'flex';
        }

        // Mostra modal para alterar modelo
        function showModelModal(sessionId, currentModel) {
            const modal = document.getElementById('sessionModal');
            document.getElementById('modalTitle').textContent = 'Alterar Modelo OpenRouter';
            document.getElementById('modalBody').innerHTML = 
                '<div class="form-group">' +
                    '<label for="newModel">Modelo:</label>' +
                    '<input type="text" id="newModel" class="form-control" value="' + currentModel + '" placeholder="Digite o modelo desejado (ex: anthropic/claude-3-haiku:beta)">' +
                    '<small class="text-muted">O modelo ser√° usado nas pr√≥ximas execu√ß√µes desta sess√£o</small>' +
                '</div>';
            document.getElementById('modalFooter').innerHTML = 
                '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>' +
                '<button class="btn btn-primary" onclick="updateSessionModel(\'' + sessionId + '\')">Atualizar</button>';
            
            modal.style.display = 'flex';
        }

        // Renomeia sess√£o
        async function renameSession(sessionId) {
            const newName = document.getElementById('newSessionName').value.trim();
            if (!newName) {
                showNotification('Nome n√£o pode estar vazio', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/sessions/' + sessionId + '/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Sess√£o renomeada com sucesso!', 'success');
                    closeModal();
                    loadSavedSessions(); // Atualiza a lista
                } else {
                    showNotification('Erro ao renomear sess√£o: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro ao renomear sess√£o:', error);
                showNotification('Erro ao renomear sess√£o', 'error');
            }
        }

        // Atualiza modelo da sess√£o
        async function updateSessionModel(sessionId) {
            const newModel = document.getElementById('newModel').value;

            try {
                const response = await fetch('/api/sessions/' + sessionId + '/model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: newModel })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Modelo atualizado com sucesso!', 'success');
                    closeModal();
                    loadSavedSessions(); // Atualiza a lista
                } else {
                    showNotification('Erro ao atualizar modelo: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro ao atualizar modelo:', error);
                showNotification('Erro ao atualizar modelo', 'error');
            }
        }

        // Remove sess√£o
        async function deleteSession(sessionId) {
            if (!confirm('Tem certeza que deseja excluir esta sess√£o?')) {
                return;
            }

            try {
                const response = await fetch('/api/sessions/' + sessionId + '/delete', {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Sess√£o exclu√≠da com sucesso!', 'success');
                    loadSavedSessions(); // Atualiza a lista
                } else {
                    showNotification('Erro ao excluir sess√£o: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir sess√£o:', error);
                showNotification('Erro ao excluir sess√£o', 'error');
            }
        }

        // Fecha modal
        function closeModal() {
            document.getElementById('sessionModal').style.display = 'none';
        }

        // Gera ID √∫nico para sess√£o
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Pega dados do formul√°rio
        function getFormData() {
            return {
                segmento: document.getElementById('segmento').value,
                produto: document.getElementById('produto').value,
                preco: document.getElementById('preco').value,
                objetivo_receita: document.getElementById('objetivo_receita').value,
                publico: document.getElementById('publico').value,
                contexto_adicional: document.getElementById('contexto_adicional').value
            };
        }

        // Inicializa funcionalidades de sess√£o quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedSessions();
            setupEventListeners();
            ensureButtonsEnabled();
        });

        function ensureButtonsEnabled() {
            // Garante que todos os bot√µes das etapas estejam sempre habilitados
            document.getElementById('step1Btn').disabled = false;
            document.getElementById('step2Btn').disabled = false;
            document.getElementById('step3Btn').disabled = false;
            console.log('‚úÖ Todos os bot√µes das etapas habilitados');
        }

        function setupEventListeners() {
            // Auto-save configura√ß√£o
            const form = document.getElementById('analysisForm');
            if (form) {
                form.addEventListener('change', saveConfiguration);
            }

            // Atalhos de teclado
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter para iniciar workflow completo
                if (e.ctrlKey && e.key === 'Enter' && !workflowRunning) {
                    e.preventDefault();
                    startCompleteWorkflow();
                }
            });
        }

        function saveConfiguration() {
            const config = getFormData();
            localStorage.setItem('arqv30_config_v3', JSON.stringify(config));
        }

        function loadSavedConfiguration() {
            const saved = localStorage.getItem('arqv30_config_v3');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    Object.entries(config).forEach(([key, value]) => {
                        const element = document.getElementById(key);
                        if (element && value) {
                            element.value = value;
                        }
                    });
                } catch (error) {
                    console.error('Erro ao carregar configura√ß√£o:', error);
                }
            }
        }

        // ===== WORKFLOW STEPS =====
        async function startStep1() {
            const segmento = document.getElementById('segmento').value;
            const produto = document.getElementById('produto').value;
            const publico = document.getElementById('publico').value;

            if (!segmento.trim()) {
                showNotification('Por favor, preencha pelo menos o segmento de mercado', 'warning');
                return;
            }

            // Gera currentSessionId se n√£o existir
            if (!currentSessionId) {
                currentSessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
                console.log('üÜï Novo currentSessionId gerado:', currentSessionId);
                
                // Salva automaticamente a sess√£o quando inicia an√°lise
                try {
                    await saveSession();
                    console.log('üíæ Sess√£o salva automaticamente ao iniciar an√°lise');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao salvar sess√£o automaticamente:', error);
                }
            }

            try {
                setStepLoading(1, true);
                showProgressSection();

                const response = await fetch('/api/workflow/step1/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        segmento: segmento,
                        produto: produto,
                        publico: publico
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentSessionId = result.session_id;
                    showNotification('Etapa 1 iniciada com sucesso! Session: ' + currentSessionId, 'success');
                    startProgressMonitoring();
                    updateStepStatus(1, 'running');
                    workflowRunning = true;
                } else {
                    showNotification('Erro na Etapa 1: ' + result.error, 'error');
                    setStepLoading(1, false);
                }
            } catch (error) {
                console.error('Erro na Etapa 1:', error);
                showNotification('Erro ao iniciar Etapa 1', 'error');
                setStepLoading(1, false);
            }
        }

        async function startStep2() {
            if (!currentSessionId) {
                showNotification('Execute a Etapa 1 primeiro', 'warning');
                return;
            }

            try {
                setStepLoading(2, true);
                showNotification('Etapa 2 iniciada: S√≠ntese com IA...', 'info');
                updateStepStatus(2, 'running');

                const response = await fetch('/api/workflow/step2/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Etapa 2 em andamento!', 'success');
                    // O monitoramento cuidar√° da conclus√£o e habilita√ß√£o da pr√≥xima etapa
                } else {
                    showNotification('Erro na Etapa 2: ' + result.error, 'error');
                    setStepLoading(2, false);
                    updateStepStatus(2, 'error');
                }
            } catch (error) {
                console.error('Erro na Etapa 2:', error);
                showNotification('Erro ao iniciar Etapa 2', 'error');
                setStepLoading(2, false);
                updateStepStatus(2, 'error');
            }
        }

        async function startAIVerification() {
            if (!currentSessionId) {
                showNotification('Execute as etapas anteriores primeiro', 'warning');
                return;
            }

            try {
                setStepLoading('aiVerification', true);
                showNotification('Verifica√ß√£o AI iniciada: Analisando dados...', 'info');
                updateStepStatus('aiVerification', 'running');

                const response = await fetch('/api/workflow/external_ai_verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Verifica√ß√£o AI em andamento!', 'success');
                    // O monitoramento cuidar√° da conclus√£o
                } else {
                    showNotification('Erro na Verifica√ß√£o AI: ' + result.error, 'error');
                    setStepLoading('aiVerification', false);
                    updateStepStatus('aiVerification', 'error');
                }
            } catch (error) {
                console.error('Erro na Verifica√ß√£o AI:', error);
                showNotification('Erro ao iniciar Verifica√ß√£o AI', 'error');
                setStepLoading('aiVerification', false);
                updateStepStatus('aiVerification', 'error');
            }
        }

        async function startStep3() {
            if (!currentSessionId) {
                showNotification('Execute as etapas anteriores primeiro', 'warning');
                return;
            }

            try {
                setStepLoading(3, true);
                showNotification('Etapa 3 iniciada: Gerando m√≥dulos...', 'info');
                updateStepStatus(3, 'running');

                const response = await fetch('/api/workflow/step3/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Etapa 3 em andamento!', 'success');
                    // O monitoramento cuidar√° da conclus√£o
                } else {
                    showNotification('Erro na Etapa 3: ' + result.error, 'error');
                    setStepLoading(3, false);
                    updateStepStatus(3, 'error');
                }
            } catch (error) {
                console.error('Erro na Etapa 3:', error);
                showNotification('Erro ao iniciar Etapa 3', 'error');
                setStepLoading(3, false);
                updateStepStatus(3, 'error');
            }
        }

        function startCompleteWorkflow() {
            if (workflowRunning) {
                showNotification('O workflow j√° est√° em execu√ß√£o.', 'warning');
                return;
            }
            // Simula o clique nos bot√µes na ordem correta, se eles estiverem habilitados
            if (document.getElementById('step1Btn').disabled === false) {
                startStep1();
            } else {
                showNotification('Etapa 1 ainda n√£o est√° pronta.', 'warning');
            }
        }

        function setStepLoading(stepNumber, isLoading) {
            let buttonId = stepNumber === 'aiVerification' ? 'aiVerificationBtn' : 'step' + stepNumber + 'Btn';
            const button = document.getElementById(buttonId);
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            spinner.style.display = isLoading ? 'inline-block' : 'none';

            if (button) {
                const existingSpinner = button.querySelector('.loading-spinner');
                if (existingSpinner) {
                    existingSpinner.remove();
                }
                if (isLoading) {
                    button.insertBefore(spinner, button.firstChild);
                }
                button.disabled = isLoading;
            }
        }
        
        function updateStepStatus(stepNumber, status) {
            let cardId = stepNumber === 'aiVerification' ? 'aiVerificationCard' : 'step' + stepNumber + 'Card';
            let buttonId = stepNumber === 'aiVerification' ? 'aiVerificationBtn' : 'step' + stepNumber + 'Btn';
            
            const card = document.getElementById(cardId);
            if (card) {
                card.className = 'step-card ' + status; // Limpa classes e adiciona a nova
            }
            
            const button = document.getElementById(buttonId);
            if (button) {
                if (status === 'completed') {
                    button.disabled = false; // Mant√©m habilitado mesmo ap√≥s conclus√£o
                    const spinner = button.querySelector('.loading-spinner');
                    if(spinner) spinner.style.display = 'none';
                } else if (status === 'running') {
                     // J√° tratado em setStepLoading
                } else if (status === 'error') {
                    button.disabled = false; // Mant√©m habilitado mesmo com erro
                    const spinner = button.querySelector('.loading-spinner');
                    if(spinner) spinner.style.display = 'none';
                }
            }
            updateStepIndicator(stepNumber, status);
        }
        
        function updateStepIndicator(stepNumber, status) {
            let indicatorId = stepNumber === 'aiVerification' ? 'indicatorAI' : 'indicator' + stepNumber;
            const indicator = document.getElementById(indicatorId);
            if (indicator) {
                indicator.className = 'step-indicator'; // Reseta
                if (status === 'completed') {
                    indicator.classList.add('completed');
                } else if (status === 'running' || status === 'active') {
                    indicator.classList.add('active');
                }
            }
        }

        function showProgressSection() {
            document.getElementById('progressSection').style.display = 'block';
        }
        
        function hideProgressSection() {
             document.getElementById('progressSection').style.display = 'none';
        }

        function updateProgressDisplay(status) {
            const progressTitle = document.getElementById('progressTitle');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            
            let currentStep = status.current_step || 0;
            let percentage = status.progress_percentage || 0;
            let message = status.message || 'Processando...';

            // Atualiza baseado no status mais recente
            if (status.step_status?.step1 === 'completed') {
                currentStep = Math.max(currentStep, 1);
                percentage = Math.max(percentage, 33);
                message = status.message || 'Etapa 1 conclu√≠da';
            }
            if (status.step_status?.step2 === 'completed') {
                currentStep = Math.max(currentStep, 2);
                percentage = Math.max(percentage, 66);
                message = status.message || 'Etapa 2 conclu√≠da';
            }
            if (status.step_status?.step3 === 'completed') {
                currentStep = Math.max(currentStep, 3);
                percentage = Math.max(percentage, 100);
                message = status.message || 'Etapa 3 conclu√≠da';
            }
            
            // Anima√ß√£o suave da barra de progresso com precis√£o melhorada
            const progressBarElement = document.getElementById('progressBar');
            if (progressBarElement) {
                progressBarElement.style.width = percentage + '%';
            }
            
            // Atualiza√ß√£o dos elementos com formata√ß√£o melhorada
            const icon = percentage === 100 ? 'fa-check-circle' : (percentage > 0 ? 'fa-cogs fa-spin' : 'fa-cogs');
            progressTitle.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            progressPercentage.textContent = Math.round(percentage * 10) / 10 + '%';
            progressStatus.textContent = message;
        }

        function startProgressMonitoring() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }

            progressInterval = setInterval(async () => {
                if (!currentSessionId) return;

                try {
                    const response = await fetch('/api/workflow/status/' + currentSessionId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.warn('Resposta n√£o √© JSON v√°lido, tentando texto...');
                        const text = await response.text();
                        console.log('Resposta recebida:', text.substring(0, 200));
                        return; // Pula esta itera√ß√£o
                    }
                    
                    const status = await response.json();
                    updateProgressDisplay(status);

                    // Habilita bot√µes baseado no progresso
                    if (status.step_status && status.step_status.step1 === 'completed') {
                        updateStepStatus(1, 'completed');
                        enableStepButton(2);
                        console.log('‚úÖ Etapa 1 conclu√≠da - habilitando Etapa 2');
                    }

                    if (status.step_status && status.step_status.step2 === 'completed') {
                        updateStepStatus(2, 'completed');
                        enableStepButton('aiVerification');
                        console.log('‚úÖ Etapa 2 conclu√≠da - habilitando Verifica√ß√£o AI');
                    }

                    if (status.ai_verification_completed) {
                        updateStepStatus('aiVerification', 'completed');
                        enableStepButton(3);
                        console.log('‚úÖ Verifica√ß√£o AI conclu√≠da - habilitando Etapa 3');
                    }

                    if (status.step_status && status.step_status.step3 === 'completed') {
                        updateStepStatus(3, 'completed');
                        console.log('‚úÖ Etapa 3 conclu√≠da - workflow finalizado');
                        clearInterval(progressInterval);
                        showNotification('Workflow conclu√≠do com sucesso!', 'success');
                        showResultsSection();
                        workflowRunning = false;
                    }
                } catch (error) {
                    console.error('Erro no monitoramento:', error);
                }
            }, 3000);
        }

        function enableStepButton(stepNumber) {
            let buttonId = stepNumber === 'aiVerification' ? 'aiVerificationBtn' : '#step' + stepNumber + 'Btn';
            const button = document.querySelector(buttonId.startsWith('#') ? buttonId : '#' + buttonId);
            if (button) {
                button.disabled = false;
                button.classList.remove('disabled'); // Remove classe disabled se houver
                const spinner = button.querySelector('.loading-spinner');
                if (spinner) spinner.style.display = 'none'; // Esconde spinner se estiver vis√≠vel
                console.log('üîì Bot√£o ' + (stepNumber === 'aiVerification' ? 'da Verifica√ß√£o AI' : 'da Etapa ' + stepNumber) + ' habilitado');
            }
        }

        function showResultsSection() {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'inline-flex';
        }
        
        function hideResultsSection() {
             document.getElementById('resultsSection').style.display = 'none';
             document.getElementById('downloadBtn').style.display = 'none';
        }

        async function showResults() {
            if (!currentSessionId) {
                showNotification('Nenhuma sess√£o ativa para carregar resultados', 'warning');
                return;
            }
            try {
                const response = await fetch('/api/workflow/results/' + currentSessionId);
                const results = await response.json();

                showResultsSection();

                // Popula vis√£o geral
                populateOverview(results);

                // Popula m√≥dulos
                populateModules(results);

                // Popula screenshots
                populateScreenshots(results);

                // Popula dados
                populateData(results);

            } catch (error) {
                console.error('Erro ao carregar resultados:', error);
                showNotification('Erro ao carregar resultados', 'error');
            }
        }

        function populateOverview(results) {
            const content = document.getElementById('overviewContent');
            const modulesGenerated = results.modules_generated || 0;
            const screenshotsCaptured = results.screenshots_captured || 0;
            const availableFiles = results.available_files ? results.available_files.length : 0;
            const finalReportAvailable = results.final_report_available ? 'SIM' : 'N√ÉO';

            content.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${modulesGenerated}</div>
                        <div class="stat-label">M√≥dulos Gerados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${screenshotsCaptured}</div>
                        <div class="stat-label">Screenshots</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${availableFiles}</div>
                        <div class="stat-label">Arquivos Gerados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${finalReportAvailable}</div>
                        <div class="stat-label">Relat√≥rio Final</div>
                    </div>
                </div>

                ${results.final_report_available ? `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Relat√≥rio Final Dispon√≠vel!</strong><br>
                            An√°lise completa com 16 m√≥dulos especializados gerada com sucesso.
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function populateModules(results) {
            const content = document.getElementById('modulesContent');
            const modules = results.modules_list || [];

            if (modules.length === 0) {
                content.innerHTML = '<p>Nenhum m√≥dulo gerado ainda.</p>';
                return;
            }

            const modulesList = modules.map((module, index) => `
                <div class="alert alert-success">
                    <i class="fas fa-file-alt"></i>
                    <div>
                        <strong>${module.replace('.md', '').replace('_', ' ').toUpperCase()}</strong><br>
                        <small>M√≥dulo ${index + 1}/16 - Gerado com sucesso</small>
                    </div>
                </div>
            `).join('');

            content.innerHTML = `
                <h4>M√≥dulos Gerados (${modules.length}/16)</h4>
                ${modulesList}
            `;
        }

        function populateScreenshots(results) {
            const content = document.getElementById('screenshotsContent');
            const screenshots = results.screenshots_list || [];

            if (screenshots.length === 0) {
                content.innerHTML = '<p>Nenhum screenshot capturado.</p>';
                return;
            }

            const screenshotsList = screenshots.map((screenshot, index) => `
                <div class="alert alert-info">
                    <i class="fas fa-image"></i>
                    <div>
                        <strong>Screenshot ${index + 1}</strong><br>
                        <small>${screenshot}</small>
                    </div>
                </div>
            `).join('');

            content.innerHTML = `
                <h4>Screenshots Capturados (${screenshots.length})</h4>
                <p>Evid√™ncias visuais do conte√∫do viral identificado durante a busca.</p>
                ${screenshotsList}
            `;
        }

        function populateData(results) {
            const content = document.getElementById('dataContent');
            const files = results.available_files || [];

            const filesList = files.map(file => `
                <div class="alert alert-secondary">
                    <i class="fas fa-file"></i>
                    <div>
                        <strong>${file.name}</strong><br>
                        <small>Tipo: ${file.type.toUpperCase()} ‚Ä¢ Tamanho: ${formatFileSize(file.size)}</small>
                    </div>
                </div>
            `).join('');

            content.innerHTML = `
                <h4>Arquivos Gerados (${files.length})</h4>
                ${filesList}
            `;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        function resetWorkflow() {
            if (confirm('Tem certeza que deseja resetar o workflow?')) {
                currentSessionId = null;
                workflowRunning = false;
                if (progressInterval) clearInterval(progressInterval);
                progressInterval = null;

                hideProgressSection();
                hideResultsSection();
                
                // Reset step cards and buttons
                updateStepStatus(1, '');
                updateStepStatus(2, '');
                updateStepStatus('aiVerification', '');
                updateStepStatus(3, '');
                
                // Mant√©m todos os bot√µes sempre habilitados
                document.getElementById('step1Btn').disabled = false;
                document.getElementById('step2Btn').disabled = false;
                document.getElementById('aiVerificationBtn').disabled = false;
                document.getElementById('step3Btn').disabled = false;

                // Limpa campos do formul√°rio (opcional, pode ser sobrescrito ao carregar config)
                document.getElementById('analysisForm').reset();
                
                showNotification('Workflow resetado', 'info');
            }
        }

        async function downloadResults() {
            if (!currentSessionId) {
                showNotification('Nenhuma sess√£o ativa para download', 'warning');
                return;
            }

            try {
                window.open('/api/workflow/download/' + currentSessionId + '/final_report', '_blank');
                showNotification('Download iniciado', 'success');
            } catch (error) {
                showNotification('Erro no download', 'error');
            }
        }

        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            const icons = {
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle'
            };

            notification.innerHTML = `
                <i class="${icons[type]}"></i>
                <span>${message}</span>
            `;

            container.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, duration);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>

    <!-- Chat Flutuante -->
    <div id="chatContainer" class="chat-container">
        <div id="chatToggle" class="chat-toggle" onclick="toggleChat()">
            <i class="fas fa-comments"></i>
            <span class="chat-badge" id="chatBadge" style="display: none;">1</span>
        </div>
        
        <div id="chatWindow" class="chat-window" style="display: none;">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-robot"></i>
                    <span>UBIE Assistant</span>
                </div>
                <div class="chat-actions">
                    <button onclick="clearChat()" class="chat-action-btn" title="Limpar conversa">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button onclick="toggleChat()" class="chat-action-btn" title="Fechar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div id="chatMessages" class="chat-messages">
                <div class="chat-message bot-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            Ol√°! Sou o UBIE, seu assistente especializado em an√°lise de mercado e marketing digital. Como posso ajudar voc√™ hoje?
                        </div>
                        <div class="message-time">Agora</div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" id="chatInput" class="chat-input" 
                           placeholder="Digite sua mensagem..." 
                           onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendChatMessage()" class="chat-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div id="chatTyping" class="chat-typing" style="display: none;">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>UBIE est√° digitando...</span>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Chat Styles */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chat-toggle {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        .chat-toggle i {
            color: white;
            font-size: 24px;
        }

        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .chat-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 380px;
            height: 500px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-2xl);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: var(--gradient-primary);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-weight: 600;
        }

        .chat-actions {
            display: flex;
            gap: 5px;
        }

        .chat-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chat-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            max-width: 85%;
        }

        .chat-message.user-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .bot-message .message-avatar {
            background: var(--gradient-primary);
            color: white;
        }

        .user-message .message-avatar {
            background: var(--gradient-accent);
            color: white;
        }

        .message-content {
            flex: 1;
        }

        .message-text {
            background: var(--bg-tertiary);
            padding: 12px 15px;
            border-radius: 15px;
            color: var(--text-primary);
            line-height: 1.4;
            word-wrap: break-word;
        }

        .user-message .message-text {
            background: var(--primary-color);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 5px;
            text-align: right;
        }

        .user-message .message-time {
            text-align: left;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            padding: 12px 15px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary-color);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .chat-send-btn:hover {
            transform: scale(1.1);
        }

        .chat-typing {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            color: var(--text-muted);
            font-size: 12px;
        }

        .typing-indicator {
            display: flex;
            gap: 3px;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .chat-window {
                width: 320px;
                height: 450px;
            }
        }

        @media (max-width: 480px) {
            .chat-container {
                bottom: 10px;
                right: 10px;
            }
            
            .chat-window {
                width: calc(100vw - 20px);
                height: 400px;
                right: -10px;
            }
        }
    </style>

    <script>
        // Chat Variables
        let chatSessionId = null;
        let chatOpen = false;

        // Chat Functions
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            const chatToggle = document.getElementById('chatToggle');
            
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                chatWindow.style.display = 'flex';
                chatToggle.style.transform = 'scale(0.9)';
                document.getElementById('chatInput').focus();
                
                // Inicializa sess√£o de chat se necess√°rio
                if (!chatSessionId) {
                    chatSessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
            } else {
                chatWindow.style.display = 'none';
                chatToggle.style.transform = 'scale(1)';
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Limpa input
            input.value = '';
            
            // Adiciona mensagem do usu√°rio
            addChatMessage(message, 'user');
            
            // Mostra indicador de digita√ß√£o
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: chatSessionId,
                        context: {
                            current_session: currentSessionId,
                            page: 'main_interface'
                        }
                    })
                });
                
                const data = await response.json();
                
                // Remove indicador de digita√ß√£o
                hideTypingIndicator();
                
                if (data.success) {
                    // Adiciona resposta do bot
                    addChatMessage(data.response, 'bot', data.metadata);
                } else {
                    addChatMessage('Desculpe, ocorreu um erro. Tente novamente.', 'bot');
                }
                
            } catch (error) {
                console.error('Erro no chat:', error);
                hideTypingIndicator();
                addChatMessage('Erro de conex√£o. Verifique sua internet e tente novamente.', 'bot');
            }
        }

        function addChatMessage(message, sender, metadata = {}) {
            const messagesContainer = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            const avatar = sender === 'user' ? 
                '<i class="fas fa-user"></i>' : 
                '<i class="fas fa-robot"></i>';
            
            const time = new Date().toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${avatar}
                </div>
                <div class="message-content">
                    <div class="message-text">${message}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // Scroll para baixo
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('chatTyping').style.display = 'flex';
        }

        function hideTypingIndicator() {
            document.getElementById('chatTyping').style.display = 'none';
        }

        async function clearChat() {
            if (!chatSessionId) return;
            
            try {
                await fetch(`/api/chat/clear/${chatSessionId}`, {
                    method: 'POST'
                });
                
                // Limpa mensagens visualmente
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = `
                    <div class="chat-message bot-message">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-text">
                                Conversa limpa! Como posso ajudar voc√™?
                            </div>
                            <div class="message-time">Agora</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao limpar chat:', error);
            }
        }

        // Inicializa√ß√£o do chat
        document.addEventListener('DOMContentLoaded', function() {
            // Chat j√° inicializado
        });
    </script>

</body>
</html>